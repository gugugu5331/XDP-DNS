# XDP DNS Filter 架构图

## 1. 系统整体架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            XDP DNS Filter                                │
│                         混合架构系统设计                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                        控制面 (Go)                                 │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌──────────┐  │  │
│  │  │   Config    │  │    Rules    │  │   Metrics   │  │   HTTP   │  │  │
│  │  │   Manager   │  │   Engine    │  │  Collector  │  │   API    │  │  │
│  │  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └────┬─────┘  │  │
│  │         │                │                │               │        │  │
│  └─────────┼────────────────┼────────────────┼───────────────┼────────┘  │
│            │                │                │               │           │
│  ┌─────────▼────────────────▼────────────────▼───────────────▼────────┐  │
│  │                      混合处理器 (Hybrid Processor)                   │  │
│  │                                                                     │  │
│  │             ┌──────────────┐    ┌──────────────┐                    │  │
│  │             │   C++ DNS    │    │   Go Trie    │                    │  │
│  │             │   Parser     │───▶│   Matcher    │                    │  │
│  │             │   (12ns)     │    │   (160ns)    │                    │  │
│  │             └──────────────┘    └──────────────┘                    │  │
│  │                                                                     │  │
│  │    CGO Bridge ◄────────────────────────────────────────────────►    │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
│                                      │                                    │
│  ┌───────────────────────────────────▼─────────────────────────────────┐  │
│  │                      AF_XDP Socket (Zero-Copy)                       │  │
│  │         Fill Ring │ Completion Ring │ RX Ring │ TX Ring              │  │
│  └───────────────────────────────────┬─────────────────────────────────┘  │
│                                      │                                    │
├──────────────────────────────────────┼────────────────────────────────────┤
│                                      │                                    │
│  ┌───────────────────────────────────▼─────────────────────────────────┐  │
│  │                         eBPF/XDP Layer                               │  │
│  │   ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐   │  │
│  │   │  Parse  │─▶│  Parse  │─▶│  Parse  │─▶│  Check  │─▶│ Redirect│   │  │
│  │   │   ETH   │  │   IP    │  │   UDP   │  │  Port   │  │   XDP   │   │  │
│  │   └─────────┘  └─────────┘  └─────────┘  └─────────┘  └─────────┘   │  │
│  │                                                                      │  │
│  │                          Kernel Space                                │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 2. 数据流图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            数据流处理                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌──────────┐                                                          │
│   │  Client  │                                                          │
│   │  DNS 查询│                                                          │
│   └────┬─────┘                                                          │
│        │                                                                │
│        ▼                                                                │
│   ┌──────────────────────────────────────────┐                          │
│   │ 1. XDP 快速过滤                           │                          │
│   │    - 非 DNS 流量 → 直接放行               │                          │
│   │    - DNS 流量 → 重定向到用户态            │                          │
│   └──────────────────────┬───────────────────┘                          │
│                          │                                              │
│        ┌─────────────────┴──────────────────┐                           │
│        │                                    │                           │
│        ▼                                    ▼                           │
│   ┌─────────┐                          ┌─────────┐                      │
│   │非 DNS   │                          │ DNS     │                      │
│   │ 放行    │                          │ 处理    │                      │
│   └─────────┘                          └────┬────┘                      │
│                                             │                           │
│        ┌────────────────────────────────────┘                           │
│        │                                                                │
│        ▼                                                                │
│   ┌──────────────────────────────────────────┐                          │
│   │ 2. C++ DNS 解析 (12ns)                    │                          │
│   │    - 解析 DNS 头部                        │                          │
│   │    - 提取域名 (零拷贝)                    │                          │
│   │    - 获取查询类型                         │                          │
│   └──────────────────────┬───────────────────┘                          │
│                          │                                              │
│                          ▼                                              │
│   ┌──────────────────────────────────────────┐                          │
│   │ 3. Go Trie 匹配 (160ns)                   │                          │
│   │    - 精确域名匹配                         │                          │
│   │    - 通配符匹配                           │                          │
│   │    - 返回: Action + Rule                  │                          │
│   └──────────────────────┬───────────────────┘                          │
│                          │                                              │
│        ┌─────────────────┼─────────────────┐                            │
│        │                 │                 │                            │
│        ▼                 ▼                 ▼                            │
│   ┌─────────┐       ┌─────────┐       ┌─────────┐                       │
│   │ ALLOW   │       │  BLOCK  │       │REDIRECT │                       │
│   └────┬────┘       └────┬────┘       └────┬────┘                       │
│        │                 │                 │                            │
│        ▼                 ▼                 ▼                            │
│   ┌─────────┐  ┌──────────────────┐  ┌──────────────────┐               │
│   │ 转发    │  │ C++ 构建 NXDOMAIN │  │ C++ 构建 A 记录  │               │
│   │ 上游 DNS│  │     (24ns)        │  │     (4ns)        │               │
│   └────┬────┘  └────────┬─────────┘  └────────┬─────────┘               │
│        │                │                     │                         │
│        └────────────────┼─────────────────────┘                         │
│                         │                                               │
│                         ▼                                               │
│                    ┌─────────┐                                          │
│                    │     │                                          │
│                    │  返回   │                                          │
│                    └─────────┘                                          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 3. 模块依赖图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         模块依赖关系                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│                        ┌─────────────────┐                              │
│                        │   cmd/dns-filter│                              │
│                        │   (主程序入口)   │                              │
│                        └────────┬────────┘                              │
│                                 │                                       │
│              ┌──────────────────┼──────────────────┐                    │
│              │                  │                  │                    │
│              ▼                  ▼                  ▼                    │
│     ┌─────────────┐    ┌─────────────┐    ┌─────────────┐              │
│     │  pkg/config │    │ pkg/metrics │    │  internal/  │              │
│     │   配置管理   │    │   监控指标   │    │   worker    │              │
│     └─────────────┘    └─────────────┘    └──────┬──────┘              │
│                                                  │                      │
│                                                  ▼                      │
│                                         ┌─────────────┐                 │
│                                         │ pkg/dns/    │                 │
│                                         │  hybrid     │                 │
│                                         │ (混合处理器) │                 │
│                                         └──────┬──────┘                 │
│                              ┌─────────────────┼─────────────────┐      │
│                              │                 │                 │      │
│                              ▼                 ▼                 ▼      │
│                     ┌─────────────┐   ┌─────────────┐   ┌────────────┐  │
│                     │ pkg/dns/    │   │ pkg/filter  │   │ pkg/dns/   │  │
│                     │  cppbridge  │   │   (规则     │   │  parser    │  │
│                     │ (CGO绑定)   │   │    引擎)    │   │ (Go解析)   │  │
│                     └──────┬──────┘   └─────────────┘   └────────────┘  │
│                            │                                            │
│                            ▼                                            │
│              ┌─────────────────────────────────────┐                    │
│              │           cpp/ (C++ 库)              │                    │
│              │  ┌───────────┐    ┌───────────────┐  │                    │
│              │  │dns_parser │    │cgo_bridge     │  │                    │
│              │  │(DNS 解析) │    │(C 接口桥接)   │  │                    │
│              │  └───────────┘    └───────────────┘  │                    │
│              └─────────────────────────────────────┘                    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 4. 性能对比图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         性能对比 (ns)                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  DNS 解析:                                                              │
│  Go:  ████████████████████████████████████████████████████████ 770ns   │
│  C++: █ 12ns                                                            │
│                                                                         │
│  NXDOMAIN 响应:                                                         │
│  Go:  ██████████████████████████████████████████████████ 1226ns        │
│  C++: █ 24ns                                                            │
│                                                                         │
│  A 记录响应:                                                            │
│  Go:  ████████████████████████████████████████████████████████ 2205ns  │
│  C++: ▏ 4ns                                                             │
│                                                                         │
│  Trie 匹配:                                                             │
│  Go:  ██████████████████████████ 160ns  ← Go 更快!                      │
│  C++: ████████████████████████████████████████████████████ 359ns       │
│                                                                         │
│  端到端 (Block):                                                        │
│  纯Go:  ████████████████████████████████████████████████████ 2125ns    │
│  混合:  ████████████████████████████ 724ns                              │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---
*文档版本: 1.0 | 更新日期: 2025-12-02*

