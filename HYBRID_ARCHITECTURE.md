# æ··åˆæ¶æ„è®¾è®¡æ–‡æ¡£

## æ¦‚è¿°

XDP DNS Filter é‡‡ç”¨æ··åˆæ¶æ„ï¼Œç»“åˆ C++ é«˜æ€§èƒ½æ•°æ®é¢å’Œ Go çµæ´»ç®¡ç†é¢çš„ä¼˜åŠ¿ã€‚

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Go æ§åˆ¶é¢                            â”‚
â”‚  â€¢ é…ç½®ç®¡ç†  â€¢ è§„åˆ™åŠ è½½  â€¢ Metrics â€¢ HTTP API   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ CGO è°ƒç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ··åˆæ•°æ®é¢                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ C++ è§£æ â”‚â†’â”‚ Go åŒ¹é…  â”‚â†’â”‚ C++ å“åº” â”‚        â”‚
â”‚  â”‚  (12ns)  â”‚  â”‚ (160ns)âœ…â”‚  â”‚  (24ns)  â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ€§èƒ½å¯¹æ¯”

### å•æ“ä½œæ€§èƒ½ (çº¯åº“è°ƒç”¨)

| æ“ä½œ | Go | C++ | æå‡ |
|------|-----|-----|------|
| DNS Parse | 770 ns | **12 ns** | **64x** |
| Build NXDOMAIN | 1226 ns | **24 ns** | **51x** |
| Build A Response | 2205 ns | **3.5 ns** | **630x** |
| Trie Match | **160 ns** | 359 ns | Go å¿« 2.2x âœ… |

### ç«¯åˆ°ç«¯æ€§èƒ½

| åœºæ™¯ | çº¯ Go | æ··åˆæ¶æ„ | æå‡ |
|------|-------|---------|------|
| Allow | 715 ns | 621 ns | 1.2x |
| Block + Response | 2125 ns | **724 ns** | **2.9x** |
| Redirect + Response | 3174 ns | **~800 ns** | **4.0x** |

### å†…å­˜åˆ†é…

| åœºæ™¯ | çº¯ Go | æ··åˆæ¶æ„ | å‡å°‘ |
|------|-------|---------|------|
| Allow | 10 allocs | 6 allocs | -40% |
| Block | 35 allocs | 8 allocs | -77% |
| Redirect | 71 allocs | 8 allocs | -89% |

## å®ç°ç»†èŠ‚

### C++ æ•°æ®é¢ (`cpp/`)

- **DNS è§£æ**: é›¶æ‹·è´ï¼Œç›´æ¥åœ¨ç½‘ç»œå­—èŠ‚åºä¸Šæ“ä½œ
- **å“åº”æ„å»º**: é¢„åˆ†é…ç¼“å†²åŒºï¼Œé¿å…ä»»ä½•å†…å­˜åˆ†é…
- **DomainTrie**: é«˜æ€§èƒ½åŸŸååŒ¹é… (åŸå­æ“ä½œç»Ÿè®¡)

### Go ç®¡ç†é¢ (`pkg/`)

- **Trie åŒ¹é…**: ä¿ç•™åœ¨ Go (æ€§èƒ½æ›´ä¼˜)
- **è§„åˆ™ç®¡ç†**: çµæ´»çš„è§„åˆ™åŠ è½½å’Œçƒ­æ›´æ–°
- **Metrics**: å®Œæ•´çš„æ€§èƒ½ç›‘æ§

### CGO ç»‘å®š (`pkg/dns/cppbridge/`)

```go
// C++ é«˜æ€§èƒ½è§£æ
result, err := cppbridge.Parse(packet)  // ~12ns (CGO å¼€é”€ ~100-200ns)

// C++ é«˜æ€§èƒ½å“åº”æ„å»º
response, err := cppbridge.BuildNXDomain(packet)  // ~24ns
response, err := cppbridge.BuildAResponse(packet, ip, ttl)  // ~3.5ns
```

### æ··åˆå¤„ç†å™¨ (`pkg/dns/hybrid/`)

```go
processor, _ := hybrid.NewProcessor(engine)
result, _ := processor.Process(packet)

// æ€»å»¶è¿Ÿ: ~720ns, ååé‡: ~1.4M PPS (å•æ ¸)
```

## æ€§èƒ½ä¼˜åŒ–è¦ç‚¹

### âœ… ä¸ºä»€ä¹ˆä¿ç•™ Go çš„ Trie åŒ¹é…?

1. Go å†…ç½® map é«˜åº¦ä¼˜åŒ–ï¼Œæ¯” C++ std::unordered_map å¿« 2x
2. é¿å…è¿‡åº¦çš„ CGO è°ƒç”¨ (100-200ns å¼€é”€)
3. ä¿æŒä»£ç çµæ´»æ€§ï¼Œæ˜“äºç»´æŠ¤è§„åˆ™

### âš ï¸ CGO å¼€é”€å½±å“

- æ¯æ¬¡ CGO è°ƒç”¨çº¦ 100-200ns å¼€é”€
- æ•°æ®æ‹·è´æˆæœ¬
- å®é™…ç«¯åˆ°ç«¯æå‡ 1.2-4x (è€Œéå•æ“ä½œçš„ 50-600x)

### ğŸš€ æœªæ¥ä¼˜åŒ–æ–¹å‘

1. **æ‰¹é‡å¤„ç†**: ä¸€æ¬¡ CGO è°ƒç”¨å¤„ç†å¤šä¸ªæ•°æ®åŒ…
2. **å…±äº«å†…å­˜**: ä½¿ç”¨ mmap å‡å°‘æ•°æ®æ‹·è´
3. **çº¯ C++ æ•°æ®é¢**: é¿å… CGO å¼€é”€ (éœ€è¦å®Œæ•´é‡å†™)

## ç¼–è¯‘å’Œæµ‹è¯•

```bash
# ç¼–è¯‘ C++ åº“
cd cpp/build
cmake .. -DCMAKE_BUILD_TYPE=Release
make -j$(nproc)

# C++ æµ‹è¯•
./xdp_dns_tests      # å•å…ƒæµ‹è¯•
./xdp_dns_benchmark  # æ€§èƒ½æµ‹è¯•

# Go æµ‹è¯•
export LD_LIBRARY_PATH=$PWD/../cpp/build
go test -bench=. ./pkg/dns/hybrid/
go test -bench=. ./tests/benchmark/
```

## æ¨èä½¿ç”¨åœºæ™¯

- **<1M PPS**: çº¯ Go å®ç°å·²è¶³å¤Ÿ
- **1-10M PPS**: æ··åˆæ¶æ„æ˜¯æœ€ä¼˜é€‰æ‹©
- **>10M PPS**: è€ƒè™‘çº¯ C++ æˆ–æ‰¹é‡å¤„ç†

## ç›¸å…³æ–‡ä»¶

- `tests/benchmark/results/BENCHMARK_REPORT.md` - è¯¦ç»†æ€§èƒ½æŠ¥å‘Š
- `cpp/include/xdp_dns/cgo_bridge.h` - C API å®šä¹‰
- `pkg/dns/cppbridge/` - Go CGO ç»‘å®š
- `pkg/dns/hybrid/` - æ··åˆå¤„ç†å™¨

