# XDP DNS Threat Analyzer

é«˜æ€§èƒ½ DNS å¨èƒæµé‡åˆ†æç³»ç»Ÿï¼ŒåŸºäº XDP (eXpress Data Path) å’Œ AF_XDP Socket æŠ€æœ¯å®ç°ã€‚

## ç³»ç»Ÿç›®æ ‡

**DNS å¨èƒæµé‡åˆ†æ** - å®æ—¶æ£€æµ‹å’Œè¯†åˆ« DNS å±‚é¢çš„å®‰å…¨å¨èƒï¼ŒåŒ…æ‹¬ï¼š
- æ¶æ„è½¯ä»¶ C2 (Command & Control) åŸŸå
- é’“é±¼ç½‘ç«™åŸŸå
- DNS éš§é“å¯ç–‘æµé‡
- å¹¿å‘Šè¿½è¸ªåŸŸå

## æ ¸å¿ƒæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        DNS å¨èƒæµé‡åˆ†ææ ¸å¿ƒæµç¨‹                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ç½‘å¡é©±åŠ¨   â”‚â”€â”€â”€â–¶â”‚  XDP ç¨‹åº   â”‚â”€â”€â”€â–¶â”‚ AF_XDP      â”‚â”€â”€â”€â–¶â”‚ ç”¨æˆ·æ€   â”‚ â”‚
â”‚  â”‚  (NIC)     â”‚    â”‚ DNS è¿‡æ»¤    â”‚    â”‚ é›¶æ‹·è´é‡å®šå‘ â”‚    â”‚ åˆ†æç¨‹åº â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚                 â”‚                   â”‚                 â”‚       â”‚
â”‚    æ”¶åˆ°æ•°æ®åŒ…      æ£€æµ‹ DNS ç«¯å£      bpf_redirect_map()   è§£æ + åŒ¹é…  â”‚
â”‚                   (UDP 53)           å…±äº«å†…å­˜ä¼ é€’          å¨èƒè§„åˆ™     â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ç‰¹æ€§

- **è¶…ä½å»¶è¿Ÿ**: XDP åœ¨ç½‘å¡é©±åŠ¨å±‚æ‹¦æˆªæ•°æ®åŒ…ï¼Œç»•è¿‡å†…æ ¸ç½‘ç»œæ ˆ
- **é›¶æ‹·è´**: AF_XDP Socket å®ç°ç”¨æˆ·æ€é›¶æ‹·è´æ•°æ®åŒ…å¤„ç†
- **é«˜åå**: æ”¯æŒç™¾ä¸‡çº§ PPS çš„ DNS æµé‡åˆ†æèƒ½åŠ›
- **å¨èƒæ£€æµ‹**: åŸºäºè§„åˆ™çš„åŸŸåå¨èƒåŒ¹é… (ç²¾ç¡®åŒ¹é… + é€šé…ç¬¦)
- **å¤šé˜Ÿåˆ—æ”¯æŒ**: å¹¶è¡Œå¤„ç†å¤šä¸ª RX é˜Ÿåˆ—ï¼Œçº¿æ€§æ‰©å±•æ€§èƒ½
- **å¯é…ç½®å“åº”**: å¯¹å¨èƒåŸŸåè¿”å› NXDOMAINï¼Œæ”¯æŒæµ‹è¯•æ¨¡å¼
- **Prometheus ç›‘æ§**: å†…ç½®å¨èƒæ£€æµ‹æŒ‡æ ‡å¯¼å‡º
- **æ··åˆæ¶æ„**: C++ é«˜æ€§èƒ½è§£æ + Go çµæ´»è§„åˆ™å¼•æ“

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | æ€§èƒ½ | è¯´æ˜ |
|------|------|------|
| **DNS è§£æ** | 12 ns (C++) / 770 ns (Go) | ä»æ•°æ®åŒ…æå–åŸŸå |
| **è§„åˆ™åŒ¹é…** | ~200 ns | Trie æ ‘åŒ¹é… 1000+ è§„åˆ™ |
| **ç«¯åˆ°ç«¯æ£€æµ‹** | ~300-800 ns | è§£æ + å¨èƒæ£€æµ‹ |
| **ååé‡ (å•æ ¸)** | ~1.4M PPS | å¨èƒæ£€æµ‹åå |
| **ååé‡ (8æ ¸)** | ~8M PPS | å¤šæ ¸å¹¶è¡Œåˆ†æ |

## æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     User Space (Go/C++)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Config    â”‚  â”‚ DNS Parser â”‚  â”‚ Threat    â”‚  â”‚ Metrics    â”‚   â”‚
â”‚  â”‚ Manager   â”‚  â”‚ (C++/Go)   â”‚  â”‚ Detector  â”‚  â”‚ Collector  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                  AF_XDP Socket (Zero-Copy)                  â”‚â”‚
â”‚  â”‚         Fill Ring â”‚ RX Ring â”‚ å…±äº«å†…å­˜ UMEM                 â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚   eBPF Maps   â”‚
                       â”‚  (xsks_map)   â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Kernel Space (XDP/eBPF)                        â”‚
â”‚  Parse ETH â†’ Parse IP â†’ Parse UDP â†’ Check DNS â†’ bpf_redirect    â”‚
â”‚                                       Port 53    to AF_XDP      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Linux å†…æ ¸ 5.4+ (æ¨è 5.10+)
- Go 1.21+
- Clang/LLVM (å¯é€‰ï¼Œç”¨äºç¼–è¯‘ BPF ç¨‹åº)
- æ”¯æŒ XDP çš„ç½‘å¡é©±åŠ¨

### æ„å»º

#### æ–¹å¼ 1: æ··åˆæ¶æ„ (æ¨èé«˜æ€§èƒ½åœºæ™¯)

```bash
# 1. æ„å»º C++ åº“
cd cpp/build
cmake .. -DCMAKE_BUILD_TYPE=Release
make -j$(nproc)
cd ../..

# 2. æ„å»º Go åº”ç”¨
go build -o dns-filter ./cmd/dns-filter
```

#### æ–¹å¼ 2: ä¼ ç»Ÿæ–¹å¼

```bash
# å…‹éš†é¡¹ç›®
git clone <repository-url>
cd xdp-dns

# æ„å»º
make build

# æˆ–ä»…æ„å»º Go ç¨‹åº
make build-go
```

> **æ€§èƒ½å¯¹æ¯”**: æ··åˆæ¶æ„æ¯”çº¯ Go å¿« 1.2-4xï¼Œæ¨èç”¨äºé«˜æµé‡åœºæ™¯ï¼ˆ>1M PPSï¼‰

### é…ç½®

ç¼–è¾‘ `configs/config.yaml`:

```yaml
interface: eth0           # ç½‘ç»œæ¥å£
queue_start: 0            # èµ·å§‹é˜Ÿåˆ— ID
queue_count: 4            # é˜Ÿåˆ—æ•°é‡ (å¤šé˜Ÿåˆ—æ”¯æŒ)

xdp:
  num_frames: 4096        # UMEM å¸§æ•°é‡
  frame_size: 2048        # å¸§å¤§å°

workers:
  num_workers: 0          # Worker æ•°é‡ (0=è‡ªåŠ¨)
  workers_per_queue: 2    # æ¯é˜Ÿåˆ— Worker æ•°

dns:
  listen_ports:
    - 53

response:
  enabled: true           # å¯ç”¨å“åº”
  mode: "block_only"      # "block_only" æˆ– "all"(æµ‹è¯•ç”¨)
  block_response: true    # å¯¹å¨èƒè¿”å› NXDOMAIN
  nxdomain: true

metrics:
  enabled: true
  listen: ":9090"
```

ç¼–è¾‘å¨èƒæ£€æµ‹è§„åˆ™ `configs/rules.yaml`:

```yaml
# åŠ¨ä½œç±»å‹: block (å¨èƒ), log (å¯ç–‘), allow (æ­£å¸¸)
rules:
  # æ¶æ„è½¯ä»¶ C2 åŸŸå
  - id: threat-malware-c2
    priority: 100
    enabled: true
    action: block
    domains:
      - "*.malware.com"
      - "*.botnet.net"

  # å¯ç–‘ DNS éš§é“ (TXT æŸ¥è¯¢)
  - id: suspicious-tunnel
    priority: 70
    enabled: true
    action: log
    query_types: [TXT, ANY]
    domains: ["*"]
```

### è¿è¡Œ

```bash
# å¼€å‘æ¨¡å¼è¿è¡Œ
sudo make run

# æˆ–ç›´æ¥è¿è¡Œ
sudo ./build/dns-filter -config configs/config.yaml
```

### å®‰è£…ä¸ºç³»ç»ŸæœåŠ¡

```bash
sudo make install

# å¯åŠ¨æœåŠ¡
sudo systemctl start xdp-dns-filter

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u xdp-dns-filter -f
```

## é¡¹ç›®ç»“æ„

```
xdp-dns/
â”œâ”€â”€ bpf/                     # XDP/eBPF ç¨‹åº (å†…æ ¸å±‚ DNS è¿‡æ»¤)
â”‚   â”œâ”€â”€ xdp_dns_filter.c    # XDP ç¨‹åº: DNS ç«¯å£æ£€æµ‹ + AF_XDP é‡å®šå‘
â”‚   â””â”€â”€ xdp_dns_filter.h    # å…±äº«æ•°æ®ç»“æ„
â”‚
â”œâ”€â”€ xdp/                     # AF_XDP Socket å°è£…
â”‚   â”œâ”€â”€ xdp.go              # Socket åˆ›å»ºå’Œé…ç½®
â”‚   â”œâ”€â”€ program.go          # XDP ç¨‹åºåŠ è½½
â”‚   â””â”€â”€ socket.go           # é›¶æ‹·è´æ”¶å‘
â”‚
â”œâ”€â”€ pkg/
â”‚   â”œâ”€â”€ dns/                # DNS è§£æ (åªè§£æï¼Œä¸æ„å»ºå“åº”)
â”‚   â”‚   â”œâ”€â”€ parser.go       # Go DNS è§£æå™¨
â”‚   â”‚   â”œâ”€â”€ cppbridge/      # C++ é«˜æ€§èƒ½è§£æç»‘å®š
â”‚   â”‚   â””â”€â”€ hybrid/         # æ··åˆæ¶æ„å¤„ç†å™¨
â”‚   â”œâ”€â”€ filter/             # å¨èƒæ£€æµ‹å¼•æ“
â”‚   â”‚   â”œâ”€â”€ engine.go       # è§„åˆ™åŒ¹é… (Trie)
â”‚   â”‚   â””â”€â”€ types.go        # Action: block/log/allow
â”‚   â””â”€â”€ metrics/            # å¨èƒæ£€æµ‹æŒ‡æ ‡
â”‚
â”œâ”€â”€ internal/worker/         # æ•°æ®åŒ…å¤„ç†æ± 
â”œâ”€â”€ cmd/dns-filter/          # ä¸»ç¨‹åºå…¥å£
â”œâ”€â”€ configs/                 # é…ç½®å’Œè§„åˆ™æ–‡ä»¶
â””â”€â”€ tests/                   # æ€§èƒ½æµ‹è¯•
```

## ç›‘æ§

è®¿é—® `http://localhost:9090/metrics` è·å– Prometheus æŒ‡æ ‡ã€‚

ä¸»è¦æŒ‡æ ‡:
- `xdp_dns_packets_received_total` - æ¥æ”¶çš„ DNS åŒ…æ€»æ•°
- `xdp_dns_packets_blocked_total` - å¨èƒæµé‡ (è¢«æ£€æµ‹é˜»æ­¢)
- `xdp_dns_packets_logged_total` - å¯ç–‘æµé‡ (è®°å½•åˆ†æ)
- `xdp_dns_packets_allowed_total` - æ­£å¸¸æµé‡

## å¼€å‘

### æ··åˆæ¶æ„æµ‹è¯•

```bash
# C++ å•å…ƒæµ‹è¯•
cd cpp/build && ./xdp_dns_tests

# C++ æ€§èƒ½åŸºå‡†æµ‹è¯•
./xdp_dns_benchmark

# Go åŸºå‡†æµ‹è¯• (éœ€è¦ C++ åº“)
export LD_LIBRARY_PATH=$PWD/../cpp/build
go test -bench=. ./pkg/dns/hybrid/
go test -bench=. ./tests/benchmark/

# å®Œæ•´å¯¹æ¯”æµ‹è¯•
./tests/benchmark/run_benchmark.sh
```

### å¸¸è§„æµ‹è¯•

```bash
# è¿è¡Œæµ‹è¯•
make test

# è¿è¡ŒåŸºå‡†æµ‹è¯•
make bench

# ä»£ç æ ¼å¼åŒ–
make fmt
```

## æ–‡æ¡£

- [HYBRID_ARCHITECTURE.md](HYBRID_ARCHITECTURE.md) - æ··åˆæ¶æ„è¯¦ç»†è®¾è®¡æ–‡æ¡£
- [æ€§èƒ½æŠ¥å‘Š](tests/benchmark/results/BENCHMARK_REPORT.md) - å®Œæ•´çš„æ€§èƒ½å¯¹æ¯”åˆ†æ
- [docs/](docs/) - å…¶ä»–æŠ€æœ¯æ–‡æ¡£

## License

MIT License

