# XDP DNS Filter

é«˜æ€§èƒ½ DNS æµé‡è¿‡æ»¤ç³»ç»Ÿï¼ŒåŸºäº XDP (eXpress Data Path) å’Œ AF_XDP Socket æŠ€æœ¯å®ç°ã€‚

## ç‰¹æ€§

- **è¶…ä½å»¶è¿Ÿ**: åœ¨ç½‘å¡é©±åŠ¨å±‚å¤„ç†æ•°æ®åŒ…ï¼Œç»•è¿‡å†…æ ¸ç½‘ç»œæ ˆ
- **é›¶æ‹·è´**: ä½¿ç”¨ AF_XDP Socket å®ç°ç”¨æˆ·æ€é›¶æ‹·è´æ•°æ®åŒ…å¤„ç†
- **é«˜åå**: æ”¯æŒç™¾ä¸‡çº§ PPS çš„ DNS æŸ¥è¯¢å¤„ç†èƒ½åŠ›
- **çµæ´»è¿‡æ»¤**: æ”¯æŒåŸºäºåŸŸåã€IPã€æŸ¥è¯¢ç±»å‹çš„åŠ¨æ€è¿‡æ»¤è§„åˆ™
- **Prometheus ç›‘æ§**: å†…ç½®æŒ‡æ ‡å¯¼å‡ºï¼Œæ”¯æŒ Grafana å¯è§†åŒ–
- **æ··åˆæ¶æ„**: C++ é«˜æ€§èƒ½æ•°æ®é¢ + Go çµæ´»ç®¡ç†é¢

## ğŸ“Š æ€§èƒ½äº®ç‚¹ (æ··åˆæ¶æ„)

| æŒ‡æ ‡ | çº¯ Go | æ··åˆæ¶æ„ | æå‡ |
|------|-------|---------|------|
| **DNS è§£æ** | 770 ns | **12 ns** | **64x** |
| **NXDOMAIN å“åº”** | 1226 ns | **24 ns** | **51x** |
| **A è®°å½•å“åº”** | 2205 ns | **3.5 ns** | **630x** |
| **ç«¯åˆ°ç«¯ (Block)** | 2125 ns | **724 ns** | **2.9x** |
| **ç«¯åˆ°ç«¯ (Redirect)** | 3174 ns | **~800 ns** | **4.0x** |
| **å†…å­˜åˆ†é… (Block)** | 35 allocs | **8 allocs** | **-77%** |
| **ååé‡ (å•æ ¸)** | ~500K PPS | **~1.4M PPS** | **3x** |

è¯¦è§ [HYBRID_ARCHITECTURE.md](HYBRID_ARCHITECTURE.md) å’Œ [æ€§èƒ½æŠ¥å‘Š](tests/benchmark/results/BENCHMARK_REPORT.md)

## æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     User Space (Go)                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Config    â”‚  â”‚ DNS Parser â”‚  â”‚ Filter    â”‚  â”‚ Metrics    â”‚   â”‚
â”‚  â”‚ Manager   â”‚  â”‚            â”‚  â”‚ Engine    â”‚  â”‚ Collector  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                  AF_XDP Socket (Zero-Copy)                  â”‚â”‚
â”‚  â”‚    Fill Ring â”‚ Completion Ring â”‚ RX Ring â”‚ TX Ring          â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚   eBPF Maps   â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Kernel Space (XDP/eBPF)                        â”‚
â”‚     Parse ETH â†’ Parse IP â†’ Parse UDP â†’ Check DNS â†’ Redirect     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Linux å†…æ ¸ 5.4+ (æ¨è 5.10+)
- Go 1.21+
- Clang/LLVM (å¯é€‰ï¼Œç”¨äºç¼–è¯‘ BPF ç¨‹åº)
- æ”¯æŒ XDP çš„ç½‘å¡é©±åŠ¨

### æ„å»º

#### æ–¹å¼ 1: æ··åˆæ¶æ„ (æ¨èé«˜æ€§èƒ½åœºæ™¯)

```bash
# 1. æ„å»º C++ åº“
cd cpp/build
cmake .. -DCMAKE_BUILD_TYPE=Release
make -j$(nproc)
cd ../..

# 2. æ„å»º Go åº”ç”¨
go build -o dns-filter ./cmd/dns-filter
```

#### æ–¹å¼ 2: ä¼ ç»Ÿæ–¹å¼

```bash
# å…‹éš†é¡¹ç›®
git clone <repository-url>
cd xdp-dns

# æ„å»º
make build

# æˆ–ä»…æ„å»º Go ç¨‹åº
make build-go
```

> **æ€§èƒ½å¯¹æ¯”**: æ··åˆæ¶æ„æ¯”çº¯ Go å¿« 1.2-4xï¼Œæ¨èç”¨äºé«˜æµé‡åœºæ™¯ï¼ˆ>1M PPSï¼‰

### é…ç½®

ç¼–è¾‘ `configs/config.yaml`:

```yaml
interface: eth0      # ç½‘ç»œæ¥å£
queue_id: 0         # é˜Ÿåˆ— ID

xdp:
  num_frames: 4096   # UMEM å¸§æ•°é‡
  frame_size: 2048   # å¸§å¤§å°

workers:
  num_workers: 8     # Worker æ•°é‡

dns:
  listen_ports:
    - 53

metrics:
  enabled: true
  listen: ":9090"
```

ç¼–è¾‘è¿‡æ»¤è§„åˆ™ `configs/rules.yaml`:

```yaml
rules:
  - id: block-ads
    priority: 100
    enabled: true
    action: block
    domains:
      - "*.ads.com"
      - "*.doubleclick.net"
```

### è¿è¡Œ

```bash
# å¼€å‘æ¨¡å¼è¿è¡Œ
sudo make run

# æˆ–ç›´æ¥è¿è¡Œ
sudo ./build/dns-filter -config configs/config.yaml
```

### å®‰è£…ä¸ºç³»ç»ŸæœåŠ¡

```bash
sudo make install

# å¯åŠ¨æœåŠ¡
sudo systemctl start xdp-dns-filter

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u xdp-dns-filter -f
```

## é¡¹ç›®ç»“æ„

```
xdp-dns/
â”œâ”€â”€ cpp/                      # C++ é«˜æ€§èƒ½æ•°æ®é¢ â­
â”‚   â”œâ”€â”€ include/xdp_dns/     # å¤´æ–‡ä»¶å’Œ C æ¥å£
â”‚   â”œâ”€â”€ src/                 # C++ å®ç° (DNS è§£æ, å“åº”æ„å»º)
â”‚   â”œâ”€â”€ tests/               # C++ å•å…ƒæµ‹è¯•
â”‚   â””â”€â”€ build/               # CMake ç¼–è¯‘è¾“å‡º
â”‚
â”œâ”€â”€ pkg/
â”‚   â”œâ”€â”€ dns/
â”‚   â”‚   â”œâ”€â”€ cppbridge/       # CGO ç»‘å®šåˆ° C++ â­
â”‚   â”‚   â”œâ”€â”€ hybrid/          # æ··åˆå¤„ç†å™¨ â­
â”‚   â”‚   â”œâ”€â”€ parser.go        # Go DNS è§£æå™¨
â”‚   â”‚   â””â”€â”€ response.go      # Go å“åº”æ„å»º
â”‚   â”œâ”€â”€ filter/              # è¿‡æ»¤å¼•æ“ (Go Trie)
â”‚   â”œâ”€â”€ config/              # é…ç½®ç®¡ç†
â”‚   â””â”€â”€ metrics/             # æŒ‡æ ‡æ”¶é›†
â”‚
â”œâ”€â”€ tests/benchmark/         # æ€§èƒ½å¯¹æ¯”æµ‹è¯• â­
â”‚   â”œâ”€â”€ e2e_benchmark_test.go
â”‚   â”œâ”€â”€ run_benchmark.sh
â”‚   â””â”€â”€ results/             # æ€§èƒ½æŠ¥å‘Š
â”‚
â”œâ”€â”€ cmd/dns-filter/          # ä¸»ç¨‹åºå…¥å£
â”œâ”€â”€ internal/worker/         # Worker å¤„ç†æ± 
â”œâ”€â”€ bpf/                     # eBPF/XDP ç¨‹åº
â”œâ”€â”€ xdp/                     # XDP Socket å°è£…
â”œâ”€â”€ configs/                 # é…ç½®æ–‡ä»¶
â”œâ”€â”€ scripts/                 # æ„å»ºè„šæœ¬
â”‚
â”œâ”€â”€ HYBRID_ARCHITECTURE.md   # æ··åˆæ¶æ„æ–‡æ¡£ â­
â””â”€â”€ README.md
```

â­ æ ‡è®°çš„æ˜¯æ–°å¢ç”¨äºæ··åˆæ¶æ„çš„æ–‡ä»¶/ç›®å½•

## ç›‘æ§

è®¿é—® `http://localhost:9090/metrics` è·å– Prometheus æŒ‡æ ‡ã€‚

ä¸»è¦æŒ‡æ ‡:
- `xdp_dns_packets_received_total` - æ¥æ”¶çš„ DNS åŒ…æ€»æ•°
- `xdp_dns_packets_blocked_total` - é˜»æ­¢çš„ DNS åŒ…æ€»æ•°
- `xdp_dns_packets_allowed_total` - å…è®¸çš„ DNS åŒ…æ€»æ•°

## å¼€å‘

### æ··åˆæ¶æ„æµ‹è¯•

```bash
# C++ å•å…ƒæµ‹è¯•
cd cpp/build && ./xdp_dns_tests

# C++ æ€§èƒ½åŸºå‡†æµ‹è¯•
./xdp_dns_benchmark

# Go åŸºå‡†æµ‹è¯• (éœ€è¦ C++ åº“)
export LD_LIBRARY_PATH=$PWD/../cpp/build
go test -bench=. ./pkg/dns/hybrid/
go test -bench=. ./tests/benchmark/

# å®Œæ•´å¯¹æ¯”æµ‹è¯•
./tests/benchmark/run_benchmark.sh
```

### å¸¸è§„æµ‹è¯•

```bash
# è¿è¡Œæµ‹è¯•
make test

# è¿è¡ŒåŸºå‡†æµ‹è¯•
make bench

# ä»£ç æ ¼å¼åŒ–
make fmt
```

## æ–‡æ¡£

- [HYBRID_ARCHITECTURE.md](HYBRID_ARCHITECTURE.md) - æ··åˆæ¶æ„è¯¦ç»†è®¾è®¡æ–‡æ¡£
- [æ€§èƒ½æŠ¥å‘Š](tests/benchmark/results/BENCHMARK_REPORT.md) - å®Œæ•´çš„æ€§èƒ½å¯¹æ¯”åˆ†æ
- [docs/](docs/) - å…¶ä»–æŠ€æœ¯æ–‡æ¡£

## License

MIT License

